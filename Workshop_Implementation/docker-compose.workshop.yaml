version: '3.8'

services:
 
  api-v1:
    build:
      context: ./Backend
      args:                     
        APP_VERSION: "1.0.0"
    image: demo-api:v1
    container_name: workshop-api-v1
    command: ["sh", "-c", "echo 'Backend v1 image ready' && tail -f /dev/null"]
    volumes:
      - image-cache:/tmp/images

  api-v2:
    build:
      context: ./Backend
      args:                    
        APP_VERSION: "2.0.0"
    image: demo-api:v2
    container_name: workshop-api-v2
    command: ["sh", "-c", "echo 'Backend v2 image ready' && tail -f /dev/null"]
    volumes:
      - image-cache:/tmp/images

  # Build frontend and make it available to k3s
  web:
    build:
      context: ./Frontend
      args:
        VITE_API_BASE: http://localhost:30080/api
    image: demo-web:local
    container_name: workshop-web-image
    command: ["sh", "-c", "echo 'Frontend image ready' && tail -f /dev/null"]
    volumes:
      - image-cache:/tmp/images

  # Main k3s cluster with auto-deploy
  k3s:
    image: rancher/k3s:v1.28.4-k3s1
    container_name: workshop-k3s
    privileged: true
    tmpfs:
      - /run
      - /var/run
    environment:
      - K3S_KUBECONFIG_OUTPUT=/output/kubeconfig.yaml
      - K3S_KUBECONFIG_MODE=666
    volumes:
      - k3s-data:/var/lib/rancher/k3s
      - ./kubeconfig:/output
      # Mount k8s manifests to a read location, not the auto-deploy location
      - ./k8s:/k8s:ro
      - image-cache:/tmp/images
    ports:
      - "30080:30080"
      - "30081:30081"
      - "30082:30082"
      - "6443:6443"
    command:
      - server
      - --disable=traefik
      - --disable=servicelb
    depends_on:
      - api-v1
      - api-v2
      - web
    healthcheck:
      test: ["CMD", "kubectl", "get", "nodes"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 30s

  # Image loader service - loads built images into k3s containerd
  image-loader:
    image: docker:24-cli
    container_name: workshop-image-loader
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - image-cache:/tmp/images
    depends_on:
      k3s:
        condition: service_healthy
      api-v1:
        condition: service_started
      api-v2:
        condition: service_started
      web:
        condition: service_started
    entrypoint: /bin/sh
    command:
      - -c
      - |
        set -e
        echo "==================================="
        echo "Loading Images into k3s"
        echo "==================================="
        
        # Wait a bit for k3s containerd to be ready
        sleep 10
        
        # Load backend v1 image
        echo "üì¶ Loading backend v1 image (demo-api:v1)..."
        docker save demo-api:v1 | docker exec -i workshop-k3s ctr images import - 2>&1 | grep -v "unpacking" || echo "Backend v1 loaded"
        
        # Load backend v2 image
        echo "üì¶ Loading backend v2 image (demo-api:v2)..."
        docker save demo-api:v2 | docker exec -i workshop-k3s ctr images import - 2>&1 | grep -v "unpacking" || echo "Backend v2 loaded"
        
        # Load frontend image  
        echo "üì¶ Loading frontend image (demo-web:local)..."
        docker save demo-web:local | docker exec -i workshop-k3s ctr images import - 2>&1 | grep -v "unpacking" || echo "Frontend image loaded"
        
        echo ""
        echo "‚úÖ Images loaded successfully!"
        echo ""
        
        # Verify images are in k3s
        echo "üìã Verifying images in k3s..."
        docker exec workshop-k3s ctr images list | grep demo || echo "Warning: Images not found"
        
        echo ""
        echo "‚úÖ Image loading complete!"
        echo ""
        
        # Keep container running
        tail -f /dev/null

  # Deployer service - applies k8s manifests after images are loaded
  deployer:
    image: rancher/k3s:v1.28.4-k3s1
    container_name: workshop-deployer
    depends_on:
      k3s:
        condition: service_healthy
      image-loader:
        condition: service_started
    environment:
      - KUBECONFIG=/output/kubeconfig.yaml
    volumes:
      - ./kubeconfig:/output
      - ./k8s:/k8s:ro
    network_mode: "service:k3s"
    entrypoint: /bin/sh
    command:
      - -c
      - |
        set -e
        echo "==================================="
        echo "Deploying Workshop Components"
        echo "==================================="
        
        # Wait for kubeconfig
        while [ ! -f /output/kubeconfig.yaml ]; do
          sleep 1
        done
        
        # Wait a bit for images to be loaded
        sleep 15
        
        echo "üì¶ Deploying Kubernetes Dashboard..."
        kubectl apply -f /k8s/dashboard.yaml
        
        echo "üì¶ Deploying backend..."
        kubectl apply -f /k8s/backend.yaml
        
        echo "üì¶ Deploying frontend..."
        kubectl apply -f /k8s/frontend.yaml
        
        echo "üì¶ Deploying HPA (HorizontalPodAutoscaler)..."
        kubectl apply -f /k8s/hpa.yaml
        
        echo "üì¶ Deploying load generator (starts at 0 replicas)..."
        kubectl apply -f /k8s/load-generator.yaml
        
        echo ""
        echo "‚è≥ Waiting for deployments to be ready..."
        kubectl wait --for=condition=available deployment/backend -n workshop --timeout=120s || true
        kubectl wait --for=condition=available deployment/frontend -n workshop --timeout=120s || true
        kubectl wait --for=condition=available deployment/kubernetes-dashboard -n kubernetes-dashboard --timeout=120s || true
        
        echo ""
        echo "==================================="
        echo "‚úÖ Setup Complete!"
        echo "==================================="
        echo ""
        echo "üåê Access your applications:"
        echo "   Frontend:   http://localhost:30081"
        echo "   Backend:    http://localhost:30080/health"
        echo "   Dashboard:  https://localhost:30082"
        echo ""
        echo "‚ö†Ô∏è  Dashboard uses HTTPS with self-signed cert"
        echo "    Click 'Advanced' and 'Proceed' in your browser"
        echo "    Then click 'Skip' on the login page"
        echo ""
        echo "üîç Check status:"
        echo "   docker exec workshop-k3s kubectl get pods -n workshop"
        echo "   docker exec workshop-k3s kubectl get hpa -n workshop"
        echo ""
        echo "üìä Check metrics:"
        echo "   docker exec workshop-k3s kubectl top pods -n workshop"
        echo ""
        
        # Keep container running
        tail -f /dev/null

volumes:
  k3s-data:
  image-cache: